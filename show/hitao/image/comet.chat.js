
/* @file comet.chat.js
 * @date 2016.07.14 16:11:12 
 */
!function(a,b){a.TChat=a.Class.create(),a.TChat.prototype={name:"TChat",options:null,data:null,connectParams:["userid","usertoken","sessionid","destid","machineID","devicetype","chattype","chatvalue","username","userlevel","settingid"],connect:null,debug:!1,login:!1,status:!1,defBody:{bold:!1,italic:!1,color:"000000",fontsize:"14",underline:!1},abnormalCount:0,loginAbnormalCount:0,fontsize:14,_reCount:0,callback:"",disconnectparams:null,_waitReconnectTimeID:null,robotQueue:0,initialize:function(b){this.callback="tchat_"+a.randomChar(),this.hashSend=new a.HASH,this.hashComplete=new a.HASH,this.hashReceive=new a.HASH,this.data=a.store,this._reCount=0,this.options=a.extend({devicetype:a.browser.mobile?3:0,chattype:"0",chatvalue:"0"},b),(!this.options.pcid||this.options.pcid.length<=10)&&(this.options.pcid=this.data.get("machineid"),(!this.options.pcid||this.options.pcid.length<=10)&&(this.options.pcid=a.base._createScriptPCID())),this.data.set("machineid",this.options.pcid),this.options.userid||(this.options.userid=a.base.userIdFix+this.options.pcid.substr(0,21)),this.debug&&a.Log("initialize comet chatConnect"),this.status=!0,this.firstConnected=!0,this._initQueue(),this.loginConnect()},loginConnect:function(){var b=this,c=this._toArray(this.options,this.connectParams);a.Log("connect tChat:"+c.join(","),1),this.connect=new a.comet(this.options.tchatgoserver,{timeout:10,onCallback:function(){b._onCallback.apply(b,arguments)},onComplete:function(){b._onComplete.apply(b,arguments)},onAbnormal:function(){b._onAbnormal.apply(b,arguments)},onTimeout:function(){b._onTimeout.apply(b,arguments)}}),this.sessionIdleReplys={},this.sessionIdleReplys[+this.options.disconnecttime]="超时未发送消息，自动断开连接",this.connect.connect({ac:"conn",action:"roomconnect",login:!0,params:c.join(","),timeout:10})},kaliveConnect:function(b){a.Log("nTalk.TChat.kaliveConnect("+b+")",1);var c=this,d=this._toArray(this.options,this.connectParams),e={ac:"kalive",action:"roomconnect",login:!1,params:d.join(","),clientid:this.options.clientid,timeout:10};return this.status?void setTimeout(function(){c.connect.kalive(e)},1e3):void a.Log("stop kalive connect")},reconnect:function(){var b=this;return++this._reCount<=3?this._waitTime=500:this._waitTime=1e3*+"034567890".charAt(Math.ceil(5*Math.random())),this.status?void(this._waitReconnectTimeID=setTimeout(function(){b.connect.reconnect()},this._waitTime)):void a.Log("stop reconnect")},disconnect:function(){for(var a in this.sessionIdleReplys)this.sessionIdleTimeouts&&this.sessionIdleTimeouts[a]&&clearTimeout(this.sessionIdleTimeouts[a].id);this.status=!1,clearTimeout(this._waitReconnectTimeID),this._waitReconnectTimeID=null,this.connect.disconnect()},sendMessage:function(b){var c,d;b=a.isObject(b)?b:a.JSON.parseJSON(b),b=a.charFilter(b),d=a.whereGet(b,["type","msgid"],["type","msgid"]),b.url&&(d=a.extend(d,a.whereGet(b,["url","emotion","oldfile","size","extension","sourceurl","mp3","length"]))),c={action:"remoteSendMessage",myuid:this.options.userid,clientid:this.options.clientid,sessionid:this.options.sessionid,flashuid:b.timerkeyid,type:"",fs:this.fontsize},1===b.type?a.extend(c,{msgid:b.msgid,style:0,type:1,msg:b.msg}):(a.extend(c,{msgid:b.msgid,msg:{msg:a.extend(b.msg,{attributes:d})}}),c.msg.msg.evaluate&&(c.msg.msg.evaluate=a.JSON.toJSONString(c.msg.msg.evaluate)),c.msg=a.jsonToxml(c.msg)),this.hashSend.add(c.msgid,c),5===b.type||this.robotQueue||this.processSessionIdle(),this._splitParcels(c)},sendAbnormal:function(b){var c=this.hashSend.items(b),d=a.getTime(),e=a.extend({},{type:9,msgType:2,timesample:d,msgid:d+"J",userid:"system",body:c},c);delete e.timerkeyid,this._callback("fIM_receiveMessage",[e])},_splitParcels:function(b){var c,d,e,f,g,h=a.browser.mobile?300:768,i=0,j=0,k=[];for(d=encodeURIComponent(b.msg),e=Math.ceil(d.length/h);d.length>0;){for(f=!0,h=h<=d.length?h:d.length;f;){g=d.substring(0,h);try{g=decodeURIComponent(g),f=!1}catch(l){h--}}c={msgid:b.msgid,index:j,body:a.extend({},b,{sendpacket:j,packetcount:e,msg:g})},k.push(c),this.messageQueue.addMessage(c),this.startSend(c),j++,i=h,d=d.substring(i,d.length)}return k},startSend:function(b){b&&this.login&&(b.timestamp&&b.recount||(b.timestamp=a.getTime(),b.recount=1),this.connect.send(a.extend({callback:this.callback},b.body)))},_callbackComplete:function(a,b,c){a&&(this.messageQueue.removeMessage(b,c),this.hashComplete.add(b,this.hashSend.items(b)))},verificationMessage:function(){var b=this.messageQueue.first(),c=a.getTime(),d=0,e=2;if(this.login)for(;b;){if(c-b.timestamp>=3e3)if(b.recount>=3)this.sendAbnormal(b.msgid),this.messageQueue.removeMessage(b.msgid,-1);else{if(d>=e){b=this.messageQueue.nextMessage(b.msgid,b.body.sendpacket);continue}d++,b.timestamp=c,b.recount=b.recount+1,this.startSend(b)}b=this.messageQueue.nextMessage(b.msgid,b.body.sendpacket)}},closeTChat:function(){this.disconnect()},setTextStyle:function(a){a&&a.fontsize&&(this.fontsize=a.fontsize)},predictMessage:function(b){var c={action:"onPredictMessage",myuid:this.options.userid,clientid:this.options.clientid,sessionid:this.options.sessionid,msg:b};this.connect.send(c,function(b){a.Log("comet.TChat.predictMessage()")})},LoginResult:function(b,c,d,e,f,g){this.login=b===!0,this.options.result=b===!0?1:0,this.options.clientid=c,this.options.sessionid=e,this.options.soid=f,this.options.time=g;try{this.options.userinfo=a.JSON.parseJSON(d)}catch(h){this.options.userinfo=this.options.userinfo||{}}if(this._callback("fIM_tchatFlashReady",[this.options.userid,this.options.pcid,this.options.settingid]),this.options.result){this.firstConnected===!0&&(this.firstConnected=!1,this.processSessionIdle()),this.userinfo=a.extend({},{myuid:this.options.userinfo.userid,myuname:this.options.userinfo.username,signature:"",mylogo:this.options.userinfo.usericon,sessionid:this.options.sessionid,timesample:this.options.time});var i=this.options.userid.split("_ISME9754_");this.disconnectparams={from:"TCHAT",cid:this.options.clientid,sitid:this.options.siteid,uid:2==i.length?i[1]:""},this.flashGoURL=this.connect.disconnectServer(this.disconnectparams,!1)}return this.options.userinfo&&this.options.userinfo.connectable===!1?void this._callback("fIM_onGetUserInfo",['{"status": 0}']):(this.options.result?(this.kaliveConnect("login kalive"),this._callback("fIM_setTChatGoServer",[this.flashGoURL]),this._reCount=0):(this.reconnect("login relogin"),this.userinfo="",this.flashGoURL=""),void this._callback("fIM_ConnectResult",[this.options.result,this.userinfo,""]))},remoteHistroyMessage:function(){for(var b,c,d,e=this,f=(arguments[0],0),g=[],h={history:1},i=1;i<arguments.length;i++)switch(i%4){case 1:h.timestamp=arguments[i];break;case 2:h.userid=arguments[i];break;case 3:h=a.extend(h,a.whereGet(a.JSON.parseJSON(arguments[i]),["externalname","usericon","nickname","username"],["name","logo","nickname","username"]));break;case 0:if(b=arguments[i],null===b||""===b||-1!=b.indexOf("<msgtype"))continue;if(b=b.replace(/<\?xml\s+version=\"1\.0\"\s+encoding=\"utf\-\d+\"\?>/gi,""),b=b.replace(/&(?!amp;)/gi,"&amp;"),c=a.htmlToElement(b)[0],d=c&&3==c.nodeType?{msg:c.textContent}:a.elementToObject(c),"true"==d.xnlink&&d.msg){var j=new RegExp(/\[[0-9]*\].+[\n]/g);d.msg=d.msg.replace("&amp;lt;![CDATA[","").replace("<![CDATA[","").replace("]]>","");var k=d.msg.match(j);if(k&&k.length>0){d.msg=d.msg.substring(0,d.msg.indexOf(k[0]));for(var l=0,m=k.length;m>l;l++)k[l]=k[l].replace(/[\n]/g,""),k[l]="[link robotindex="+k[l].replace(/\[[0-9]*\]\s/,"")+"]"+k[l]+"[/link]\n",d.msg+=k[l]}}else if(7==d.type&&b){var n=b.replace(/</g,"&lt;").replace(/>/g,"&gt;").match("&lt;content&gt;(.+?)&lt;/content&gt;");n&&n.length>=2&&(d.msg=a.base64.decode(n[1]))}else d.msg=c.textContent||c.text,"string"==typeof d.msg&&(d.msg=d.msg.replace(/</g,"&lt;"));h=a.extend(h,this.defBody,d),g.push(h),h={history:1}}a.each(g,function(a,b){setTimeout(function(){e._callback("fIM_receiveMessage",[b])},f),f+=50})},remoteSendMessage:function(b,c,d,e,f){var g,h,i;if(e&&!(e.indexOf('type="5"')>-1&&-1===e.indexOf('systype="5"'))){d&&"string"==typeof d&&(d=a.JSON.parseJSON(d),d=a.whereGet(d,["usericon","userid","externalname"],["logo","userid","name"])),e=e.replace(/<\?xml\s+version=\"1\.0\"\s+encoding=\"utf\-\d+\"\?>/gi,""),e=e.replace(/&(?!amp;)/gi,"&amp;");try{i=a.htmlToElement(e)[0],h=i&&3==i.nodeType?{type:1,msg:i.textContent,msgid:f+"x"}:a.elementToObject(i)}catch(j){return void a.Log("remoteSendMessage:"+j.description+"; xmlString:"+e,3)}if("true"==h.xnlink&&h.msg){var k=new RegExp(/\[[0-9]*\].+[\n]/g);h.msg=h.msg.replace("&amp;lt;![CDATA[","").replace("<![CDATA[","").replace("]]>","");var l=h.msg.match(k);if(l&&l.length>0){h.msg=h.msg.substring(0,h.msg.indexOf(l[0]));for(var m=0,n=l.length;n>m;m++)l[m]=l[m].replace(/[\n]/g,""),l[m]="[link robotindex="+l[m].replace(/\[[0-9]*\]\s/,"")+"]"+l[m]+"[/link]\n",h.msg+=l[m]}}else if(7==h.type&&e){var o=e.replace(/</g,"&lt;").replace(/>/g,"&gt;").match("&lt;content&gt;(.+?)&lt;/content&gt;");o&&o.length>=2&&(h.msg=a.base64.decode(o[1]))}else h.msg=i.textContent||i.text,"string"==typeof h.msg&&(h.msg=h.msg.replace(/</g,"&lt;"));g=a.extend({},this.defBody,h,d,{timestamp:b}),this.hashSend.contains(g.msgid)||this.hashReceive.contains(g.msgid)||(this._callback("fIM_receiveMessage",[g]),this.hashReceive.add(g.msgid,g))}},remoteNotifyUserList:function(b){var c=[];try{c=a.JSON.parseJSON(b)}catch(d){a.Log("remoteNotifyUserList toJSON abnormal",3)}for(var e=0;e<c.length;e++)c[e].userid==this.options.userid&&c.splice(e,1);this._callback("fIM_notifyUserNumbers",[c.length]),this._callback("fIM_notifyUserList",[a.JSON.toJSONString(c)])},remoteSearchWaiter:function(a,b){this._callback("fIM_onGetUserInfo",[b])},remoteNotifyUserInformation:function(a,b){a!=this.options.userid&&this._callback("fIM_onGetUserInfo",[b])},remoteNotifyUserEnter:function(a,b){this.options.destid=a;var c=this._toArray(this.options,this.connectParams);this.connect&&(this.connect.connectOptions.params=c.join(","),this.connect.kaliveOptions.params=c.join(",")),this._callback("fIM_notifyUserEnter",[this.options.destid,b,""])},remoteNotifyUserLeave:function(b){a.Log("tchat.remoteNotifyUserLeave("+b+")",2),this._callback("fIM_notifyUserLeave",[b])},remoteNotifyUserClose:function(a,b){a==this.options.clientid&&(this._callback("fIM_ConnectResult",[5,"",""]),this.disconnect(),this._callback("fIM_ConnectResult",[4,"",""]))},remoteNotifySessionScene:function(a){this._callback("fIM_onNotifySessionSence",[a])},remoteNotifyUserInputing:function(a,b){this._callback("fIM_notifyUserInputing",[b])},remoteRequestEvalute:function(a,b,c){this._callback("fIM_requestEvaluate",[b,c])},processSessionIdle:function(){var b=this;this.sessionIdleTimeouts||(this.sessionIdleTimeouts={}),a.each(this.sessionIdleReplys,function(a,c){b.sessionIdleTimeouts[a]&&clearTimeout(b.sessionIdleTimeouts[a].id),b.sendIdleReply(a)})},clearSessionIdle:function(){var b=this;this.sessionIdleTimeouts||(this.sessionIdleTimeouts={}),a.each(this.sessionIdleReplys,function(a,c){b.sessionIdleTimeouts[a]&&clearTimeout(b.sessionIdleTimeouts[a].id)})},sendIdleReply:function(b){var c=this,d=a.extend(this.sessionIdleTimeouts[b],{start:a.formatDate(),id:setTimeout(function(){var d=0,e=c.sessionIdleReplys[b];delete c.sessionIdleReplys[b],c.sessionIdleTimeouts[b].end=a.formatDate(),a.each(c.sessionIdleReplys,function(a){d++}),a.Log("setTimeout "+b+"s "+c.sessionIdleTimeouts[b].end+", disconnect tchat",1),0===d&&c.connect&&c.options.result&&(c._callback("fIM_ConnectResult",[4,"",e]),c.disconnect())},1e3*b)});this.sessionIdleTimeouts[b]=d},_toArray:function(b,c){var d=[];if(!b)return"error";for(var e=0;e<c.length;e++)d.push(a.isDefined(b[c[e]])?b[c[e]]:"");return d},_handleResponse:function(b,c){this[b]?this[b].apply(this,c):a.Log("The object of the method '"+b+"' does not exist",3)},_callback:function(b,c){if(c.push(this.options.settingid),a.hasOwnProperty(b))try{a[b].apply(this,c)}catch(d){}else a.Log("nTalk."+b+"(...)",2)},_onCallback:function(a,b){var c,d=this;if(b.length)if(c=b[0],"LoginResult"===c){if(!a)return!1;this.LoginResult.apply(d,b.slice(1))}else this._handleResponse.call(d,c,b.slice(1)),a&&(this.abnormalCount=0,this.kaliveConnect("call kalive"))},_onComplete:function(){var b=Array.prototype.slice.call(arguments);this.debug&&a.Log("TChat.onComplete( "+b[0]+","+b[1]+","+b[2]+" )"),"kalive"==b[0]?(this.abnormalCount=0,this.kaliveConnect("complete kalive")):"login"==b[0]&&this.reconnect("abnormal login")},_onAbnormal:function(){var b=Array.prototype.slice.call(arguments);this.debug&&a.Log("TChat.onAbnormal( "+b[0]+","+b[1]+","+b[2]+" )",3),this.abnormalCount++,"login"==b[0]||this.abnormalCount>=3?(this.abnormalCount=0,this._callback("fIM_ConnectResult",[2,"","连接服务器超时，请稍后重试！"]),this.reconnect("abnormal login")):this.kaliveConnect("abnormal kalive")},_onTimeout:function(){var b=Array.prototype.slice.call(arguments);this.debug&&a.Log("TChat.onTimeout( "+b[0]+","+b[1]+","+b[2]+" )",3),"login"==b[0]&&this.loginAbnormalCount++,this.abnormalCount++,this.loginAbnormalCount>=3||this.abnormalCount>=5?(this.abnormalCount=0,this.loginAbnormalCount=0,this._callback("fIM_ConnectResult",[2,"","连接服务器超时，请稍后重试！"]),this.reconnect("time login")):this.kaliveConnect("timeout kalive")},_initQueue:function(){var b=this;this.messageQueue=new a.Queue,this.messageQueue.first=function(){return this.queueFront()},this.messageQueue.nextMessage=function(a,b){if(b=b||0,!this.list.length)return null;if(!a)return this.list[0];for(var c=0;c<this.list.length;c++)if(this.list[c].msgid==a&&this.list[c].body.sendpacket==b)return this.list[c+1];return null},this.messageQueue.removeMessage=function(a,b){var c=[];b=b||0;for(var d=0;d<this.list.length;d++)(this.list[d].msgid!=a||this.list[d].index!=b&&-1!=b)&&c.push(this.list[d]);this.list=c,this.length=c.length},this.messageQueue.addMessage=function(a){for(var b=0;b<this.list.length;b++)if(this.list[b].msgid==a.msgid&&this.list[b].index==a.index)return!1;return this.list.push(a),this.length=this.list.length,!0},this.messageQueue.getSendingNum=function(){for(var a=0,b=0;b<this.list.length;b++)this.list[b].status&&a++;return a},window[this.callback]=function(){b._callbackComplete.apply(b,arguments)},this.sendIntervalID=setInterval(function(){b.verificationMessage()},1e3)}}}(nTalk);